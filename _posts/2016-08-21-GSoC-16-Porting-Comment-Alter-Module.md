---
layout: post
title: GSoC'16 - Porting Comment Alter Module
comments: true
categories:
- blog
---

---

For the last 3 months I’ve been working on **Porting the Comment Alter module to Drupal 8** as my GSoC’16 project under mentorship of [boobaa](https://www.drupal.org/u/boobaa) and [czigor](https://www.drupal.org/u/czigor). This blog is an excerpt of the work I did during this time period. Weekly blog posts for the past 12 weeks can be accessed [here](https://anchal29.github.io).


## Achievements ##

**Creating schema for the module:** Implemented `hook_schema()` to store the old and new entity revision IDs along with the parent entity type as altered by a comment. The revision IDs are used to show the differences over comments. The parent entity type is used to delete the entries from the comment_alter table when any revision of the parent entity is deleted, because in Drupal 8 we can have same revision IDs from different entity types. So to remove entries of particular entity type we need the entity type.


**Using ThirdPartySettings to alter field config edit form -** Implemented `hook_form_FORM_ID_alter()` for `field_config_edit_form`. This provides an interface to:

1. **Make any field comment alterable -** Makes it possible to select any field we want to be altered by the comment. Currently all the Drupal core provided fields works well with the module.

2. **Hide alteration from diff -** If the comment alterable option is enabled, then this option hides the differences shown over the comments. Instead of the differences, a link to the revision comparison is displayed for nodes. For the rest of the entities a "Changes are hidden" message is shown.

3. **Use latest revision -** When a module like Workbench makes the current revision of an entity not the latest one, this option forces the Comment Alter module to use the latest revision instead of the current one. This option is present on the comment field settings.

4. **Adds Diff link on comments -** Adds a Diff link on comments which takes us to the comparison page of two revisions, generated by the Diff module.

5. **Comment altering while replying to a comment -** By default comment alterable fields can not be altered while replying to a comment. This option allows altering of fields even while replying to comments.


**Adding pseudo fields:** Implemented `hook_entity_extra_field_info()` to add one pseudo field for each comment alterable field on respective comment form display, and one pseudo field on comment display to show the changes made at the comment. Using these pseudo fields the position of the comment alterable fields can be re-ordered in the comment form. This gives site-builders flexibility to alter the position of any alterable fields.

**Attaching comment alterable fields' widgets on comment form:** Comment alterable field widgets are retrieved from the form-display of the parent entity and they are attached to the comment form only after ensuring that there are no side effects. To support same name fields on both comment and parent entity, `#parent` property is provided so that the submitted field values for our alterable field widgets appears at a different location, not at the top level of `$form_state->getValues()`. All these added fields are re-orderable. Column informations and old values are also stored to the form at this stage, to later check if there were any changes made on the comment alterable fields.

**Adding submit and validation callback for the altered comment form:** First the submitted values are checked against the old values to see if the values of the alterable field changed at all or not. If they changed, then the parent entity values are updated and this is done by building the parent entity form display and copying the altered field values into it. Then the form is saved. In case the parent entity doesn’t support revisions, then do nothing else just save the parent entity with altered values. Otherwise create a revision and store the comment ID, old and new revision IDs and parent entity type in the comment alter database table, which is used to show the differences on comments using the Diff module.

**Showing differences on comments:** Using the Diff module and comment alter database table, the differences are shown over a particular comment. Only possible if the parent entity supports revisions. Diff module is used to get the differences between the two revisions and then those differences are rendered on comments in table format along with some custom styling.

**Adding PHPUnit tests:** Added automated unit tests to check the functionality of the module for different field types and widgets. The tests are written for EntityTestRev entity types to keep them as generic as possible. This was the toughest part for me as I was stuck at some places in tests for quite a while as thses tests took lot of time to run and debugging them really is hard. But in the end I'm happy that I was able to complete all the tests.

**Screencast/Demo video:** Created a [demo video](https://www.youtube.com/watch?v=9ZJqlbrPwxY) showing how the Comment Alter module works, along with a simple use case.

## What’s left? ##
My mentors asked me to skip the Rules Integration part because the Rules module doesn't have a stable or a beta release yet, only their first alpha release is there. So, the Rules Integration part is postponed till we get a stable or beta release.

## Some important links ##

+ My [GitHub repo](https://github.com/anchal29/comment_alter) contains all the [commits](https://github.com/anchal29/comment_alter/commits/8.x) which I made during this project

+ The [Comment Alter module's project page](https://www.drupal.org/project/comment_alter) on drupal.org

Thank you!
